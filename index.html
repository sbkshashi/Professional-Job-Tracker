<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional Job Tracker</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better appearance on mobile/desktop */
        .overflow-y-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .overflow-y-scroll::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p class="ml-3 text-indigo-600 font-semibold">Authenticating and Initializing...</p>
    </div>

    <!-- Profile Setup/Switcher Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-50 p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
            <h3 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c2.761 0 5-2.239 5-5S14.761 1 12 1 7 3.239 7 6s2.239 5 5 5zM4 21v-2a4 4 0 014-4h8a4 4 0 014 4v2"></path>
                </svg>
                Select Data Profile
            </h3>
            <p class="text-sm text-gray-600 mb-6">Since you can access this app from multiple devices, choose how you want to load your job applications.</p>

            <div class="border-t border-gray-200 pt-6 space-y-4">

                <!-- Option 1: Current Device's ID -->
                <div class="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg">
                    <p class="font-semibold text-indigo-800">1. Continue with this device's profile (New or Local):</p>
                    <p class="text-xs mt-1 text-indigo-600">
                        The current device's security ID is: <span class="font-mono font-bold" id="modal-current-auth-id">N/A</span>
                    </p>
                    <button id="use-current-profile-btn"
                        class="mt-3 w-full p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Use This Profile ID
                    </button>
                </div>

                <!-- Option 2: Load Existing Profile -->
                <div class="p-4 bg-gray-50 border border-gray-300 rounded-lg">
                    <p class="font-semibold text-gray-800 mb-3">2. Load Existing Profile (Cross-Device Sync):</p>
                    <form id="load-existing-form">
                        <input type="text" id="context-id-input" placeholder="Paste your saved User ID here"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-sm font-mono text-sm" />
                        <button type="submit"
                            class="mt-3 w-full p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                            Load Profile Data
                        </button>
                    </form>
                    <div id="context-error-message" class="text-red-500 mt-3 text-sm hidden font-medium"></div>
                </div>

                <!-- Instruction to Save ID -->
                <div class="p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-md" role="alert">
                    <p class="font-semibold text-sm">IMPORTANT:</p>
                    <p class="text-sm">If you choose to use the current ID, <strong>you must save it</strong> to load this data on other devices later.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Main Application Container (Hidden until profile is selected) -->
    <div id="app-container" class="max-w-6xl mx-auto opacity-0 transition-opacity duration-500 hidden">
        <header class="text-center mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2 sm:mb-0">My Job Pipeline</h1>
                <div class="text-right text-xs bg-white p-3 rounded-lg shadow border border-gray-200">
                    <p class="text-gray-500">
                        Data Profile ID: <span class="font-mono text-indigo-600 font-bold" id="context-display">N/A</span>
                    </p>
                    <button onclick="window.openProfileModal()" class="mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">
                        (Switch Profile)
                    </button>
                </div>
            </div>
            <p class="text-lg text-gray-600 mt-2">Tracking data from profile: <span class="font-bold text-indigo-600" id="context-display-small">N/A</span></p>
        </header>

        <!-- Add New Job Form -->
        <section class="bg-white p-6 rounded-xl shadow-2xl mb-8 border border-indigo-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New Application</h2>
            <form id="add-job-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Row 1 -->
                <input type="text" id="company" placeholder="Company Name" required
                    class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" />
                <input type="text" id="title" placeholder="Job Title" required
                    class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" />
                <input type="url" id="link" placeholder="Job Link (Optional)"
                    class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" />

                <!-- Row 2: Notes, Date, Status, Button -->
                <textarea id="notes" placeholder="Notes (e.g., Hiring Manager, salary expectations)" rows="2"
                    class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm"></textarea>
                <input type="date" id="date" required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" />
                <select id="status" required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition bg-white">
                    <option value="Applied">Applied</option>
                    <option value="Interview">Interview</option>
                    <option value="Offer">Offer</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <button type="submit"
                    class="p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50"
                    id="add-job-button">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Job
                </button>
            </form>
            <div id="error-message" class="text-red-500 mt-3 text-sm hidden"></div>
        </section>

        <!-- Job List and Filtering -->
        <section class="mt-10">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Current Applications</h2>
                <!-- Filter Dropdown -->
                <div class="flex items-center">
                    <label for="status-filter" class="flex items-center text-gray-700 mr-3 font-medium text-sm">Filter:</label>
                    <select id="status-filter" onchange="window.filterAndRender()"
                        class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition bg-white shadow-sm font-medium">
                        <option value="All">All Statuses</option>
                        <option value="Applied">Applied</option>
                        <option value="Interview">Interview</option>
                        <option value="Offer">Offer</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <div id="job-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Job cards will be injected here -->
            </div>
            <div id="empty-state" class="hidden text-center p-12 bg-white rounded-xl shadow-lg mt-8 border border-gray-200">
                <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a1 1 0 001 1h16a1 1 0 001-1V7M8 7V5a4 4 0 118 0v2"></path>
                </svg>
                <p class="mt-4 text-xl font-medium text-gray-500">No applications match the current filter.</p>
                <p class="mt-2 text-gray-400">Try adjusting the filter or adding a new job!</p>
            </div>
        </section>

        <!-- Custom Modals (Delete/Edit) - Retained for functionality -->
        <!-- Custom Modal for Delete Confirmation -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Confirm Deletion</h3>
                <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete the application for <strong id="modal-company-name"></strong>?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition shadow-md">Delete</button>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Editing Job -->
        <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Edit Application Details</h3>
                <form id="edit-job-form" onsubmit="window.saveEdit(event)">
                    <input type="hidden" id="edit-job-id" />
                    <div class="space-y-4">
                        <div>
                            <label for="edit-company" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" id="edit-company" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" />
                        </div>
                        <div>
                            <label for="edit-title" class="block text-sm font-medium text-gray-700">Job Title</label>
                            <input type="text" id="edit-title" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" />
                        </div>
                        <div>
                            <label for="edit-link" class="block text-sm font-medium text-gray-700">Job Link</label>
                            <input type="url" id="edit-link" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" />
                        </div>
                        <div>
                            <label for="edit-date" class="block text-sm font-medium text-gray-700">Application Date</label>
                            <input type="date" id="edit-date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" />
                        </div>
                        <div>
                            <label for="edit-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="edit-notes" rows="4" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>
                        </div>
                        <div id="edit-error-message" class="text-red-500 text-sm hidden"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="window.closeEditModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Mandatory Canvas Globals) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, authUserId = null; // authUserId is the ID used for security checks (generated by Firebase)
        let currentDataContextId = null; // This is the ID used for reading/writing data (chosen by user)
        let isAuthReady = false;
        let jobListenerUnsubscribe = null;
        let allJobs = [];
        let deleteJobId = null;

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const profileModal = document.getElementById('profile-modal');
        const modalCurrentAuthId = document.getElementById('modal-current-auth-id');
        const useCurrentProfileBtn = document.getElementById('use-current-profile-btn');
        const loadExistingForm = document.getElementById('load-existing-form');
        const contextIdInput = document.getElementById('context-id-input');
        const contextErrorDiv = document.getElementById('context-error-message');
        const contextDisplay = document.getElementById('context-display');
        const contextDisplaySmall = document.getElementById('context-display-small');

        const jobListContainer = document.getElementById('job-list-container');
        const addJobForm = document.getElementById('add-job-form');
        const addButton = document.getElementById('add-job-button');
        const errorDiv = document.getElementById('error-message');
        const emptyState = document.getElementById('empty-state');
        const statusFilter = document.getElementById('status-filter');

        // Delete Modal Elements
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const modalCompanyName = document.getElementById('modal-company-name');

        // Edit Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editJobIdInput = document.getElementById('edit-job-id');
        const editCompanyInput = document.getElementById('edit-company');
        const editTitleInput = document.getElementById('edit-title');
        const editLinkInput = document.getElementById('edit-link');
        const editDateInput = document.getElementById('edit-date');
        const editNotesInput = document.getElementById('edit-notes');
        const editErrorDiv = document.getElementById('edit-error-message');

        // --- Core Application Functions ---

        /**
         * Sets the data context, updates the UI, and starts the Firestore listener.
         * @param {string} id - The User ID to use for reading/writing data.
         */
        const setDataContext = (id) => {
            currentDataContextId = id;
            contextDisplay.textContent = id;
            contextDisplaySmall.textContent = id;
            profileModal.classList.remove('flex');
            profileModal.classList.add('hidden');

            appContainer.classList.remove('hidden', 'opacity-0');
            appContainer.classList.add('opacity-100');

            listenForJobs();
        };

        /**
         * Converts a status string to Tailwind CSS classes for coloring.
         */
        const getStatusStyles = (status) => {
            switch (status) {
                case 'Interview':
                    return { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-400' };
                case 'Offer':
                    return { bg: 'bg-green-50', text: 'text-green-700', border: 'border-green-400' };
                case 'Rejected':
                    return { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-400' };
                case 'Applied':
                default:
                    return { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-400' };
            }
        };

        /**
         * Generates the HTML card for a single job application.
         */
        const createJobCard = (job) => {
            const styles = getStatusStyles(job.status);
            const notesText = job.notes ? (job.notes.length > 150 ? job.notes.substring(0, 150) + '...' : job.notes) : '<span class="italic text-gray-400">No detailed notes.</span>';

            const statusOptions = ['Applied', 'Interview', 'Offer', 'Rejected']
                .map(s => `<option value="${s}" ${job.status === s ? 'selected' : ''}>${s}</option>`)
                .join('');

            return `
                <div data-id="${job.id}" class="${styles.bg} p-5 rounded-xl shadow-lg border-l-4 ${styles.border} transition-all hover:shadow-xl">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-gray-900 truncate pr-4">${escapeHtml(job.company)}</h3>
                        <div class="flex space-x-2">
                            <button title="Edit Application" onclick="window.openEditModal('${job.id}')" class="text-gray-400 hover:text-indigo-600 transition" aria-label="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h6M6 21l8.5-8.5a2 2 0 10-2.828-2.828L3 18v3h3z"></path>
                                </svg>
                            </button>
                            <button title="Delete Application" onclick="window.deleteJob('${job.id}', '${escapeHtml(job.company)}')" class="text-gray-400 hover:text-red-600 transition" aria-label="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <p class="text-md font-medium text-gray-700 mb-1">${escapeHtml(job.title || '')}</p>
                    <p class="text-sm text-gray-600 mb-3 whitespace-pre-wrap">${notesText}</p>

                    <div class="space-y-1 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3M16 7V3M3 11h18M5 21h14a2 2 0 002-2V8H3v11a2 2 0 002 2z"></path>
                            </svg>
                            <span>Applied: ${job.date ? new Date(job.date).toLocaleDateString() : 'â€”'}</span>
                        </div>
                        ${job.link ? `
                        <a href="${escapeAttr(job.link)}" target="_blank" rel="noopener noreferrer" class="flex items-center text-sm text-indigo-600 hover:text-indigo-800 transition">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14a5 5 0 007.07 0l1.415-1.414a5 5 0 00-7.07-7.071L10 6.929"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10a5 5 0 00-7.07 0L5.515 11.414a5 5 0 007.071 7.071L14 18.071"></path>
                            </svg>
                            <span>Job Link</span>
                        </a>` : ''}
                    </div>

                    <div class="flex items-center justify-between mt-4 border-t pt-3">
                        <label for="status-${job.id}" class="text-xs font-semibold text-gray-500 mr-2">Status:</label>
                        <select id="status-${job.id}" data-job-id="${job.id}"
                            onchange="window.updateJobStatus(this.getAttribute('data-job-id'), this.value)"
                            class="p-2 text-sm border-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition bg-white ${styles.text} ${styles.border}">
                            ${statusOptions}
                        </select>
                    </div>
                </div>
            `;
        };

        /**
         * Simple HTML escape for text content to reduce injection surface when injecting into templates.
         * (Note: this is a minimal escape and intended for display values; links are escaped in attributes separately.)
         */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function escapeAttr(url) {
            if (!url) return '';
            return String(url).replaceAll('"', '&quot;').replaceAll("'", '&#39;');
        }

        /**
         * Filters the global job list based on the selected status and renders the result. (Exposed globally)
         */
        window.filterAndRender = () => {
            const selectedStatus = statusFilter.value;

            // 1. Filter jobs
            const filteredJobs = selectedStatus === 'All'
                ? allJobs.slice()
                : allJobs.filter(job => job.status === selectedStatus);

            // 2. Sort by date (newest first)
            filteredJobs.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

            // 3. Render
            if (filteredJobs.length === 0) {
                jobListContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                emptyState.querySelector('p:first-child').textContent = "No applications match the current filter.";
            } else {
                emptyState.classList.add('hidden');
                jobListContainer.innerHTML = filteredJobs.map(createJobCard).join('');
            }
        };


        /**
         * Authenticates the user and sets up the Profile Modal.
         */
        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                contextErrorDiv.textContent = "Firebase configuration is missing.";
                contextErrorDiv.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication using custom token or anonymous sign-in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        authUserId = user.uid;
                        modalCurrentAuthId.textContent = authUserId; // Display security ID in modal
                        isAuthReady = true;

                        // If no context is set, open the profile modal
                        if (!currentDataContextId) {
                            window.openProfileModal();
                        }
                    } else {
                        console.log("User is signed out.");
                    }
                    loadingOverlay.classList.add('hidden');
                });

            } catch (e) {
                console.error("Error during Firebase initialization or sign-in:", e);
                loadingOverlay.classList.add('hidden');
                contextErrorDiv.textContent = `Firebase Error: ${e.message}`;
                contextErrorDiv.classList.remove('hidden');
            }
        };

        /**
         * Opens the profile selection/switcher modal. (Exposed globally)
         */
        window.openProfileModal = () => {
            if (!authUserId) {
                contextErrorDiv.textContent = "Authentication not complete. Please wait.";
                contextErrorDiv.classList.remove('hidden');
                return;
            }
            modalCurrentAuthId.textContent = authUserId;
            profileModal.classList.remove('hidden');
            profileModal.classList.add('flex');
            contextErrorDiv.classList.add('hidden'); // Clear previous errors
            contextIdInput.value = ''; // Clear input field
        };

        /**
         * Handles the click on "Use This Profile ID" in the modal.
         */
        const handleUseCurrentProfile = () => {
            if (authUserId) {
                setDataContext(authUserId);
                console.log(`Set data context to current authenticated ID: ${authUserId}`);
            }
        };

        /**
         * Handles the submission of an existing ID in the modal.
         * @param {Event} e - Form submission event.
         */
        const handleLoadExistingProfile = (e) => {
            e.preventDefault();
            const newContextId = contextIdInput.value.trim();

            if (!newContextId) {
                contextErrorDiv.textContent = "Please enter your saved User ID.";
                contextErrorDiv.classList.remove('hidden');
                return;
            }

            if (newContextId === currentDataContextId) {
                contextErrorDiv.textContent = "This ID is already loaded.";
                contextErrorDiv.classList.remove('hidden');
                return;
            }

            // In a real app, we might check if this ID exists first.
            // For now, we trust the user and attempt to load it, relying on security rules
            // to allow read access based on the current authUserId.
            setDataContext(newContextId);
            console.log(`Switched data context to manual ID: ${newContextId}`);
        };


        /**
         * Gets the Firestore collection reference for the current data context ID.
         * @returns {string} The full path to the current job applications collection.
         */
        const getCollectionPath = () => {
            if (!currentDataContextId) {
                console.error("Cannot get collection path: dataContextId is null.");
                return null;
            }
            // The path uses the ID the user has chosen to sync with
            return `artifacts/${appId}/users/${currentDataContextId}/job_applications`;
        };

        /**
         * Sets up the real-time listener for job applications based on currentDataContextId.
         */
        const listenForJobs = () => {
            if (!isAuthReady || !currentDataContextId) {
                console.warn("Attempted to listen for jobs before authentication was ready or data context set.");
                return;
            }

            // 1. Unsubscribe previous listener if it exists
            if (jobListenerUnsubscribe) {
                jobListenerUnsubscribe();
                console.log("Previous listener unsubscribed.");
                allJobs = []; // Clear current jobs immediately
                window.filterAndRender();
            }

            const path = getCollectionPath();
            if (!path) return;

            const q = query(collection(db, path));

            // 2. Subscribe to the new collection path
            jobListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allJobs = []; // Reset global job array
                snapshot.forEach((docSnap) => {
                    allJobs.push({ id: docSnap.id, ...docSnap.data() });
                });
                console.log(`Received ${allJobs.length} job updates from context: ${currentDataContextId}`);
                window.filterAndRender(); // Re-render after receiving new data
                contextErrorDiv.classList.add('hidden'); // Ensure error is hidden if successful
            }, (error) => {
                console.error(`Error listening to context ${currentDataContextId}:`, error);
                // This typically happens if the security rules block the read (e.g., trying to read an ID that doesn't match the authUserId)
                contextErrorDiv.textContent = `Error loading data for context ID: ${currentDataContextId}. Data might not exist or connection failed.`;
                contextErrorDiv.classList.remove('hidden');
                jobListenerUnsubscribe = null; // Mark listener as stopped
                allJobs = [];
                window.filterAndRender();
            });
        };

        /**
         * Adds a new job application to Firestore using the current data context ID.
         */
        const addJob = async (e) => {
            e.preventDefault();
            if (!isAuthReady || !currentDataContextId) {
                errorDiv.textContent = "Profile not selected or app is still loading.";
                errorDiv.classList.remove('hidden');
                return;
            }

            const path = getCollectionPath();
            if (!path) return;

            addButton.disabled = true;
            errorDiv.classList.add('hidden');

            const newJob = {
                company: document.getElementById('company').value.trim(),
                title: document.getElementById('title').value.trim(),
                status: document.getElementById('status').value,
                date: document.getElementById('date').value,
                link: document.getElementById('link').value.trim() || null,
                notes: document.getElementById('notes').value.trim() || null,
                timestamp: Date.now()
            };

            try {
                await addDoc(collection(db, path), newJob);
                console.log(`New job added to context: ${currentDataContextId}`);
                addJobForm.reset();
            } catch (e) {
                console.error("Error adding document:", e);
                errorDiv.textContent = `Failed to add job: ${e.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                addButton.disabled = false;
            }
        };

        /**
         * Updates the status of an existing job application. (Exposed globally)
         */
        window.updateJobStatus = async (jobId, newStatus) => {
            if (!isAuthReady || !currentDataContextId) {
                console.error("Cannot update job status: Auth not ready or data context not set.");
                return;
            }

            const path = getCollectionPath();
            if (!path) return;

            try {
                const jobRef = doc(db, path, jobId);
                await updateDoc(jobRef, { status: newStatus });
                console.log(`Job ${jobId} status updated.`);
            } catch (e) {
                console.error("Error updating job status:", e);
            }
        };


        /**
         * Opens the edit modal and populates it with the job data. (Exposed globally)
         */
        window.openEditModal = (jobId) => {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) {
                console.error("Job not found for ID:", jobId);
                return;
            }

            editJobIdInput.value = job.id;
            editCompanyInput.value = job.company || '';
            editTitleInput.value = job.title || '';
            editLinkInput.value = job.link || '';
            editDateInput.value = job.date || '';
            editNotesInput.value = job.notes || '';
            editErrorDiv.classList.add('hidden');

            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        };

        /**
         * Closes the edit modal. (Exposed globally)
         */
        window.closeEditModal = () => {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        };

        /**
         * Handles saving the edited job details. (Exposed globally)
         */
        window.saveEdit = async (e) => {
            e.preventDefault();
            if (!isAuthReady || !currentDataContextId) {
                editErrorDiv.textContent = "App is loading. Please wait.";
                editErrorDiv.classList.remove('hidden');
                return;
            }

            const path = getCollectionPath();
            if (!path) return;

            const jobId = editJobIdInput.value;
            const updatedJob = {
                company: editCompanyInput.value.trim(),
                title: editTitleInput.value.trim(),
                link: editLinkInput.value.trim() || null,
                date: editDateInput.value,
                notes: editNotesInput.value.trim() || null,
            };

            try {
                const jobRef = doc(db, path, jobId);
                await updateDoc(jobRef, updatedJob);
                console.log(`Job ${jobId} updated in context: ${currentDataContextId}`);
                window.closeEditModal();
            } catch (error) {
                console.error("Error updating job:", error);
                editErrorDiv.textContent = `Failed to save changes: ${error.message}`;
                editErrorDiv.classList.remove('hidden');
            }
        };


        /**
         * Opens the confirmation modal for deleting a job. (Exposed globally for button click)
         */
        window.deleteJob = (jobId, companyName) => {
            deleteJobId = jobId;
            modalCompanyName.textContent = companyName;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        };

        /**
         * Deletes the confirmed job application from Firestore.
         */
        const confirmDeleteJob = async () => {
            if (!deleteJobId || !isAuthReady || !currentDataContextId) {
                console.error("Cannot delete job: ID is null or Auth not ready.");
                return;
            }

            const path = getCollectionPath();
            if (!path) return;

            try {
                const jobRef = doc(db, path, deleteJobId);
                await deleteDoc(jobRef);
                console.log(`Job ${deleteJobId} deleted successfully from context: ${currentDataContextId}`);
            } catch (e) {
                console.error("Error deleting job:", e);
                errorDiv.textContent = `Failed to delete job: ${e.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                // Close modal and reset ID
                deleteJobId = null;
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            }
        };

        // --- Event Listeners ---
        addJobForm.addEventListener('submit', addJob);
        useCurrentProfileBtn.addEventListener('click', handleUseCurrentProfile);
        loadExistingForm.addEventListener('submit', handleLoadExistingProfile);

        confirmDeleteBtn.addEventListener('click', confirmDeleteJob);
        cancelDeleteBtn.addEventListener('click', () => {
            deleteJobId = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        });
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteJobId = null;
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            }
        });
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                window.closeEditModal();
            }
        });

        // Initialize the application
        initFirebase();

    </script>
</body>
</html>
